

services:
  youtube-proxy:
    build: ./proxy
    container_name: aquatiq-youtube-proxy
    restart: always
    env_file:
      - .env
    volumes:
      - ./youtube-cookies.txt:/app/youtube-cookies.txt
    shm_size: '2gb'
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=taskpriority_internal"
      - "traefik.http.routers.aquatiq-proxy.rule=Host(`youtube.sensilist.com`)"
      - "traefik.http.routers.aquatiq-proxy.entrypoints=websecure"
      - "traefik.http.routers.aquatiq-proxy.tls.certresolver=mytlschallenge"
      - "traefik.http.services.aquatiq-proxy.loadbalancer.server.port=8085"
    networks:
      - aquatiq-net
      - internal

  ntp-server:
    image: cturra/ntp
    container_name: aquatiq-ntp
    restart: always
    environment:
      - NTP_SERVERS=0.no.pool.ntp.org,1.no.pool.ntp.org
      - LOG_LEVEL=0
    ports:
      - "123:123/udp"
    networks:
      - aquatiq-net

  postgres:
    image: postgres:16-alpine
    container_name: aquatiq-postgres-local
    restart: always
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=aquatiq_signage
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./signage-server/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    ports:
      - "5432:5432"
    networks:
      - aquatiq-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  signage-server:
    build: ./signage-server
    container_name: aquatiq-signage-server
    restart: always
    env_file:
      - signage-server/.env
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=aquatiq_signage
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - VIDEOS_DIR=/app/videos
      - VIDEO_BASE_URL=http://localhost:3002
      - TOOLS_BASE_URL=http://localhost:3000
      - NODE_ENV=development
    volumes:
      - signage-videos:/app/videos
      - ./signage-server/src:/app/src
    ports:
      - "3002:3002"
    networks:
      - aquatiq-net
      - internal
    depends_on:
      postgres:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=taskpriority_internal"
      - "traefik.http.routers.aquatiq-signage.rule=Host(`signage.sensilist.com`)"
      - "traefik.http.routers.aquatiq-signage.entrypoints=websecure"
      - "traefik.http.routers.aquatiq-signage.tls.certresolver=mytlschallenge"
      - "traefik.http.services.aquatiq-signage.loadbalancer.server.port=3002"

  screenshot-server:
    build: ./screenshot-server
    container_name: aquatiq-screenshot-server
    restart: always
    env_file:
      - screenshot-server/.env
    volumes:
      - screenshot-storage:/app/screenshots
    shm_size: '2gb'
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=taskpriority_internal"
      - "traefik.http.routers.aquatiq-screenshot.rule=Host(`signage.sensilist.com`) && PathPrefix(`/screenshot`)"
      - "traefik.http.routers.aquatiq-screenshot.entrypoints=websecure"
      - "traefik.http.routers.aquatiq-screenshot.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.aquatiq-screenshot.priority=60"
      - "traefik.http.services.aquatiq-screenshot.loadbalancer.server.port=3003"
    networks:
      - aquatiq-net
      - internal

  

networks:
  aquatiq-net:
    driver: bridge
  internal:
    name: taskpriority_internal
    external: true

volumes:
  postgres-data:
    driver: local
  signage-videos:
    driver: local
  screenshot-storage:
    driver: local
